# Система аукциона предметов (Telegram-бот)

Учебный проект: многопользовательская система аукциона с интерфейсом в виде Telegram-бота.  
Пользователи могут регистрироваться, выставлять лоты, делать ставки и получать уведомления о завершении аукционов в реальном времени.

## Основные возможности

- Регистрация пользователей и хранение их баланса в памяти процесса.  
- Создание лота через пошаговый мастер: название, описание, фото, стартовая цена и длительность аукциона.  
- Просмотр активных аукционов и списка выигранных лотов.  
- Выставление ставок с проверкой минимального шага, баланса и запретом ставок на собственные лоты.  
- Автоматическое завершение аукционов фоновым таймером и отправка уведомлений создателю и победителю.  

## Технологии и архитектура

- Язык и платформа: C# / .NET 8.0.  
- Telegram-интерфейс: библиотека `Telegram.Bot` и long polling через `StartReceiving`.  
- Асинхронность: `async/await`, фоновые задачи (`Task.Run`, `Task.Delay`) для проверки истёкших аукционов и обработки обновлений.  
- Синхронизация:
  - `ReaderWriterLockSlim` для безопасного параллельного доступа к списку лотов.  
  - `lock` для эксклюзивной обработки ставок и финансовых операций по одному лоту.

### Структура проекта

- `Main/Program.cs`  
  Точка входа: включает вывод UTF‑8, читает токен бота из переменной окружения `TELEGRAM_TOKEN`, создаёт `TelegramBotClient`, доменный `AuctionHouse`, сервисы (`TelegramAuctionService`, `TelegramUserService`, `InMemoryConversationStateStore`, `TelegramMessageSender`), команды и запускает `TelegramBotHost`.

- `Domain`  
  - `AuctionHouse` — хранит все лоты, запускает фоновый таймер раз в 30 секунд для поиска истекших аукционов и поднимает событие `AuctionEnded`.  
  - `AuctionItem` — модель лота с логикой ставок, историей транзакций и завершением аукциона.  
  - `Transaction`, `UserAccount` — операции над балансом и данные пользователя (id чата, имя, баланс).

- `Application`  
  - `PostStep`, `PostFlow`, `ConversationState` — описывают шаги мастера создания лота и временно хранят введённые пользователем данные.  
  - `InMemoryConversationStateStore` — потокобезопасное in-memory хранилище состояния диалога (текущий шаг, данные лота, выбранный лот для ставки) по `chatId`.

- `Infrastructure/Telegram`  
  - `TelegramBotHost` — инициализирует получение обновлений Telegram (Message, CallbackQuery), логирует ошибки и передаёт все апдейты в `TelegramUpdateRouter`.  
  - `TelegramUpdateRouter` — маршрутизирует сообщения и нажатия кнопок: продолжает мастер создания лота, обрабатывает ввод суммы ставки или вызывает нужную команду по имени.  
  - `TelegramAuctionService` — реализация `IAuctionService` поверх `AuctionHouse`: выдаёт активные/выигранные лоты, добавляет новые и по завершении аукциона уведомляет участников через `IMessageSender`.  
  - `TelegramMessageSender` — обёртка над `TelegramBotClient` для отправки текстов, фото и ответов на callback-запросы.  
  - `TelegramUserService` — in-memory список пользователей с методами регистрации и получения максимального доступного баланса.

- `Infrastructure/Telegram/Commands`  
  Команды Telegram-бота, реализующие общий интерфейс `ITelegramCommand`:
  - `StartCommand` — регистрация пользователя и приветственное сообщение.  
  - `PostCommand` — запуск мастера создания лота.  
  - `ViewCommand` — вывод активных лотов.  
  - `ViewBalanceCommand` — показ текущего баланса пользователя.  
  - `ViewWonCommand` — список лотов, в которых пользователь победил.

## Запуск

1. Установите .NET SDK 8.0 (или совместимую версию).  
2. Создайте Telegram-бота через `@BotFather` и получите токен.  
3. Установите переменную окружения `TELEGRAM_TOKEN` со значением токена бота.  
4. Соберите и запустите проект из каталога с `.csproj`:
```dotnet run```
5. Откройте Telegram и начните диалог с вашим ботом, нажав на кнопку или отправив команду /start.
